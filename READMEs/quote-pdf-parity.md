## Quote PDF Parity (View vs Download)

Goal: Make the downloaded PDF look identical to the quote "View" page (remove unwanted top/bottom gray borders).

### Pipelines Today

- View path (HTML, rendered by HubSpot):

  - UI buttons:
    - `src/components/QuoteCards.tsx` lines ~100–113
      - View: opens `quote.properties.hs_quote_link`
      - Download: opens `quote.properties.hs_pdf_download_link`
    - `src/components/Quote/QuoteDetailsCard.tsx` lines ~83–104 mirrors the same behavior
  - Where links come from:
    - `src/actions/quote/getQuoteFullDetail.ts` fetches HubSpot quote with `hs_quote_link` and `hs_pdf_download_link`
    - `src/actions/quote/getAllQuotes.ts` also requests those properties
  - Summary: The "View" is HubSpot-hosted HTML; the "Download" is HubSpot-generated PDF.

- Download path (PDF, generated by HubSpot):
  - Button opens `hs_pdf_download_link` (HubSpot PDF export)
  - The borders/gutters are produced upstream by HubSpot's PDF export (likely Chromium defaults or a template-level print setting).

### Diagram (where they diverge)

```mermaid
flowchart LR
  UI[Next.js UI buttons]\nQuoteCards.tsx / QuoteDetailsCard.tsx -->|View| HSView[HubSpot hs_quote_link (HTML)]
  UI -->|Download| HSPdf[HubSpot hs_pdf_download_link (PDF export)]

  subgraph Proposed fix
    API[Next.js API: /api/quotes/:id/pdf]\nPuppeteer page.pdf -> PDFOut[PDF]
  end

  UI -->|Download (after fix)| API
  HSView -.optional HTML fetch.-> API
```

### Libraries & settings in this repo

- No in-repo PDF generator is currently used (no Puppeteer/Playwright/jsPDF/react-pdf found).
- All PDFs come from HubSpot `hs_pdf_download_link` today.

### Root cause(s) of borders (most likely)

Since the PDF is generated by HubSpot, the gray top/bottom borders/gutters are likely due to its export defaults:

- Default Chromium header/footer enabled
  - Fix when self-rendering: `displayHeaderFooter: false`
- Non-zero page margins
  - Fix when self-rendering: `@page { margin: 0 }` and/or Puppeteer `margin: { top: '0', right: '0', bottom: '0', left: '0' }`
- Missing `printBackground: true` and `preferCSSPageSize: true`
  - Fix when self-rendering: enable both flags to preserve backgrounds and CSS-defined page size
- Preview-only chrome (box-shadow/border) in HTML template
  - Fix when self-rendering: add `@media print` overrides to disable shadows/borders in print

Because these are upstream in HubSpot, we cannot change them in-place. To guarantee parity, we should proxy the Download through our server, rendering the same HTML used for View with our own PDF settings.

### Single source of truth (recommended approach)

1. Create a Next.js API route: `src/app/api/quotes/[id]/pdf/route.ts` that:
   - Fetches the quote via `getQuoteFullDetail.ts` to get `hs_quote_link`
   - Retrieves the HTML from `hs_quote_link` (server-side fetch; ensure cookies/auth not required)
   - Uses Puppeteer (headless Chrome) to render that HTML to PDF with strict options:

```ts
await page.pdf({
  printBackground: true,
  displayHeaderFooter: false,
  preferCSSPageSize: true,
  margin: { top: "0", right: "0", bottom: "0", left: "0" },
});
```

2. Unify print CSS (if we host a local HTML template). If we embed or proxy HTML, inject a print stylesheet to ensure no shadows/borders in print:

```css
@page {
  size: var(--pdf-page-size, Letter);
  margin: 0;
}
@media print {
  html,
  body {
    background: #fff !important;
  }
  .pdf-container {
    box-shadow: none !important;
    border: 0 !important;
  }
  .preview-chrome,
  .page-shadow {
    display: none !important;
  }
}
```

3. Update UI download buttons to call our new API route instead of `hs_pdf_download_link`.
   - Implemented: `QuoteCards.tsx` and `QuoteDetailsCard.tsx` now open `/api/quotes/${id}/pdf`.

### Implementation plan (minimal, safe)

- Add dependency: Puppeteer (local) and `puppeteer-core` + `@sparticuz/chromium` (prod)
- New route: `src/app/api/quotes/[id]/pdf/route.ts`
  - Input: `quoteId`
  - Steps: get `hs_quote_link` -> fetch HTML -> `page.setContent(HTML, { waitUntil: 'networkidle0' })` -> `page.pdf(...)`
  - Return: `application/pdf` stream
- Update UI:
  - `src/components/QuoteCards.tsx` and `src/components/Quote/QuoteDetailsCard.tsx` Download buttons to hit `/api/quotes/${quoteId}/pdf`

### Configuration (env)

- `PDF_PAGE_SIZE=letter` (or `a4`)
- `PDF_PRINT_BACKGROUND=true`
- `PDF_HEADER_FOOTER=false`
- Optional: `PDF_TIMEOUT_MS=20000`
 - Optional: `PDF_ALLOW_FALLBACK=true` (proxy HubSpot PDF if HTML blocked)

### Local parity check

1. Open a quote card and copy `hs_quote_link` and `hs_pdf_download_link` (from DevTools Network or UI props).
2. Hit our route: `/api/quotes/<id>/pdf` and download.
3. Compare visually with the View HTML.
4. If needed, log:
   - Template length/checksum of fetched HTML
   - PDF options used
   - Headers to check for fallback when HTML blocked:
     - `x-pdf-fallback: hubspot`

### Files and references

- UI buttons:
  - `src/components/QuoteCards.tsx` lines 100–114
  - `src/components/Quote/QuoteDetailsCard.tsx` lines ~83–104
- Data source for links:
  - `src/actions/quote/getQuoteFullDetail.ts`
  - `src/actions/quote/getAllQuotes.ts`

### Notes

- If the `hs_quote_link` HTML requires HubSpot auth, we may need to use the HubSpot API (or a preauthorized template endpoint) to fetch equivalent HTML.
- Ensure assets are absolute URLs; if not, rewrite to absolute before rendering to PDF.
- Keep brand fonts and images intact by serving them over HTTPS and allowing `printBackground`.

### PR

Title: `fix(pdf): make Download match View (no top/bottom borders)`

Short test plan:

- Compare one quote via View vs new Download; confirm no top/bottom borders.
- Verify backgrounds/colors render identically.
- Verify page size (Letter/A4) matches View.
